#cloud-config
package_update: false
package_upgrade: false

# Set variables that can be templated
write_files:
  - path: /etc/headscale/config-override.yaml
    content: |
      server_url: https://${domain}
      oidc:
        issuer: "${oidc_issuer}"
        client_id: "${oidc_client_id}"
        client_secret: "${oidc_client_secret}"
      dns:
        base_domain: ${base_domain}
        extra_records:
%{ for service in gated_services ~}
          - name: "${service.dns}"
            type: "A"
            value: "100.64.0.1"
%{ endfor ~}
    owner: headscale:headscale
    permissions: '0640'

%{ for service in gated_services ~}
  - path: /etc/nginx/sites-available/${replace(service.dns, ".", "-")}
    content: |
      server {
          listen 80;
          listen [::]:80;
          server_name ${service.dns};
          return 301 https://$$server_name$$request_uri;
      }
      
      server {
          listen 443 ssl http2;
          listen [::]:443 ssl http2;
          server_name ${service.dns};
          
          ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
          ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;
          
          location / {
              proxy_pass https://${service.ip == "100.64.0.1" ? "161.35.240.236" : service.ip};
              proxy_ssl_verify off;
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
              proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $$scheme;
              proxy_set_header X-VPN-Client true;
              
              # Health check
              proxy_connect_timeout 30s;
              proxy_send_timeout 30s;
              proxy_read_timeout 30s;
          }
          
          location /health {
              access_log off;
              return 200 "healthy\n";
              add_header Content-Type text/plain;
          }
      }
    owner: root:root
    permissions: '0644'
%{ endfor ~}

  - path: /usr/local/bin/certbot-nginx-retry.sh
    content: |
      #!/bin/bash
      domain="$$1"
      email="$$2"
      retries=5
      delay=60
      
      for i in $$(seq 1 $$retries); do
          echo "Attempting SSL certificate for $$domain (attempt $$i/$$retries)"
          
          # Check if certificate already exists
          if [ -f "/etc/letsencrypt/live/$$domain/fullchain.pem" ]; then
              echo "Certificate for $$domain already exists"
              return 0
          fi
          
          # Attempt to get certificate
          if certbot --nginx -d "$$domain" --non-interactive --agree-tos --email "$$email" --redirect; then
              echo "Successfully obtained certificate for $$domain"
              return 0
          else
              echo "Failed to obtain certificate for $$domain (attempt $$i/$$retries)"
              if [ $$i -lt $$retries ]; then
                  echo "Waiting $$delay seconds before retry..."
                  sleep $$delay
              fi
          fi
      done
      
      echo "Failed to obtain certificate for $$domain after $$retries attempts"
      return 1
    owner: root:root
    permissions: '0755'

runcmd:
  - echo "Starting cloud-init configuration..." >> /var/log/cloud-init-debug.log
  
  # Disable systemd-resolved to free up port 53 for Headscale DNS
  - echo "=== Disabling systemd-resolved ===" >> /var/log/cloud-init-debug.log
  - systemctl stop systemd-resolved >> /var/log/cloud-init-debug.log 2>&1
  - systemctl disable systemd-resolved >> /var/log/cloud-init-debug.log 2>&1
  - rm -f /etc/resolv.conf
  - echo -e "# Static DNS configuration for Headscale server\nnameserver 8.8.8.8\nnameserver 8.8.4.4\nnameserver 1.1.1.1\nsearch localdomain" > /etc/resolv.conf
  - chattr +i /etc/resolv.conf
  - echo "systemd-resolved disabled, port 53 freed for Headscale" >> /var/log/cloud-init-debug.log
  - ss -tulpn | grep :53 >> /var/log/cloud-init-debug.log 2>&1 || echo "Port 53 is now free" >> /var/log/cloud-init-debug.log
  
  # Mount volume and set up symlinks
  - /usr/local/bin/mount-headscale-volume.sh >> /var/log/cloud-init-debug.log 2>&1
  
  # Debug: Check if override config was written
  - echo "=== Checking config override ===" >> /var/log/cloud-init-debug.log
  - ls -la /etc/headscale/config-override.yaml >> /var/log/cloud-init-debug.log 2>&1 || echo "Override config not found" >> /var/log/cloud-init-debug.log
  - cat /etc/headscale/config-override.yaml >> /var/log/cloud-init-debug.log 2>&1 || echo "Could not read override config" >> /var/log/cloud-init-debug.log
  
  # Debug: Check port 53 availability
  - echo "=== Checking port 53 availability ===" >> /var/log/cloud-init-debug.log
  - ss -tulpn | grep :53 >> /var/log/cloud-init-debug.log 2>&1 || echo "No process listening on port 53" >> /var/log/cloud-init-debug.log
  
  # Merge the override config with the base config using yq
  - |
    if [ -f /etc/headscale/config-override.yaml ]; then
      # Install yq if not present
      if ! command -v yq &> /dev/null; then
        wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        chmod +x /usr/local/bin/yq
      fi
      
      # Backup original config
      cp /etc/headscale/config.yaml /etc/headscale/config.yaml.bak
      
      # Merge the configs properly
      yq eval-all '. as $$item ireduce ({}; . *+ $$item)' /etc/headscale/config.yaml /etc/headscale/config-override.yaml > /etc/headscale/config-merged.yaml
      mv /etc/headscale/config-merged.yaml /etc/headscale/config.yaml
      
      chown headscale:headscale /etc/headscale/config.yaml
      
      # Debug: show the final DNS config
      echo "=== Final DNS config ===" >> /var/log/cloud-init-debug.log
      yq eval '.dns' /etc/headscale/config.yaml >> /var/log/cloud-init-debug.log 2>&1
    fi
  
  # Start services (they're already enabled by Packer)
  - systemctl daemon-reload >> /var/log/cloud-init-debug.log 2>&1
  - systemctl start headscale >> /var/log/cloud-init-debug.log 2>&1
  - systemctl start nginx >> /var/log/cloud-init-debug.log 2>&1
  
  # Wait for services to start
  - sleep 5
  
  # Configure firewall using the Packer-provided script
  - ADMIN_IP=${admin_ip} /usr/local/bin/enable-ufw-tailnet.sh >> /var/log/cloud-init-debug.log 2>&1 || true
  
  # Set up SSL certificate for Headscale
  - /usr/local/bin/certbot-nginx-retry.sh ${domain} ${admin_email} >> /var/log/cloud-init-debug.log 2>&1 || true
  - systemctl reload nginx >> /var/log/cloud-init-debug.log 2>&1 || true
  
  # Configure nginx proxy sites for gated services
  - echo "=== Configuring nginx proxy sites ===" >> /var/log/cloud-init-debug.log
%{ for service in gated_services ~}
  - ln -sf /etc/nginx/sites-available/${replace(service.dns, ".", "-")} /etc/nginx/sites-enabled/
  - echo "Enabled proxy site for ${service.dns}" >> /var/log/cloud-init-debug.log
  - /usr/local/bin/certbot-nginx-retry.sh ${service.dns} ${admin_email} >> /var/log/cloud-init-debug.log 2>&1 || true
%{ endfor ~}
  
  # Test and reload nginx
  - nginx -t >> /var/log/cloud-init-debug.log 2>&1
  - |
    if [ $$? -eq 0 ]; then
        systemctl reload nginx >> /var/log/cloud-init-debug.log 2>&1
        echo "All proxy sites configured successfully" >> /var/log/cloud-init-debug.log
    else
        echo "ERROR: Nginx configuration test failed" >> /var/log/cloud-init-debug.log
    fi
  
  # Final status check
  - echo "=== Final status ===" >> /var/log/cloud-init-debug.log
  - systemctl status headscale --no-pager >> /var/log/cloud-init-debug.log 2>&1 || true
  - systemctl status nginx --no-pager >> /var/log/cloud-init-debug.log 2>&1 || true
  - ufw status >> /var/log/cloud-init-debug.log 2>&1 || true
  
  # Debug: Test Headscale DNS
  - echo "=== Testing Headscale DNS ===" >> /var/log/cloud-init-debug.log
  - sleep 10
  - ss -tulpn | grep :53 >> /var/log/cloud-init-debug.log 2>&1 || echo "No DNS service running" >> /var/log/cloud-init-debug.log
  - journalctl -u headscale --no-pager -n 20 >> /var/log/cloud-init-debug.log 2>&1 || true
  
  # Ensure cloud-init is complete
  - echo "Cloud-init configuration completed at $$(date)" >> /var/log/cloud-init-debug.log
